# Changelog

> **この変更ログについて**
> この変更ログは **ChatGPT UX Customizer (GPTUX)** と **Gemini UX Customizer (GGGUX)** とで共通です。
> ほとんどの変更は2つのスクリプト間で共通です。変更がどちらか一方にのみ適用される場合は、明示的に `[GPTUX]` または `[GGGUX]` プレフィックスで示します。

## [1.4.0] - 2025-09-05
- **[GPTUX] リファクタリング**
  - 軽微なリファクタリング。
  - `GGGUX` とのバージョン合わせ。  
- **[GGGUX] 新機能:チャット履歴の自動読み込み**
  - チャットを開いた際に全履歴を自動で読み込む新機能を追加し、何度もスクロールして過去メッセージを表示しなくてもよいようにした。  
  - デフォルトで有効。**設定パネル → 「チャット読み込み時に全履歴を読み込む」** から切り替え可能。  
  - ロード中はトースト通知を表示し、ユーザーに進行状況を伝えるとともに、*キャンセル* ボタンで中断できる。  
  - Gemini のネイティブ進捗バーを利用して確実に全メッセージを読み込む。  
  - 20件を超えるメッセージがあるチャットでのみ動作し、完了後は自動的に最新メッセージまでスクロールしてシームレスな操作性を実現。  
  - もしもチャット履歴の自動読み込み機能が早期終了する場合は、スクリプトを直接編集して以下の数値を`3000`に増やしてください: `class AutoScrollManager`内、`APPEAR_TIMEOUT_MS: 2000,`

## [1.3.8] - 2025-09-03
- **安定性とパフォーマンス向上のための UI マネージャーリファクタリング**
  - ナビゲーション後、空のチャットでも **「すべて折りたたむ」** ボタンが誤って表示される不具合を修正。可視状態はメッセージキャッシュを利用して他コンポーネントと一貫性を確保。  
  - **AvatarManager** と **StandingImageManager** をリファクタリングし、DOM クエリを繰り返すのではなくメッセージ情報を集約した `MessageCacheManager` を参照するように変更し、チャット読み込み時の効率を改善。  
  - `ObserverManager._processTurnSingle` を `observeTurnForCompletion` に改名し、JSDoc を更新して役割を明確化。  

## [1.3.7] - 2025-08-31
- **パフォーマンス強化**
  - テーマ適用を非同期化。画像以外のスタイル（色、フォント）は即座に適用し、画像はバックグラウンドでスムーズな遷移で読み込む。
  - アバターの高さ計算を最適化し、更新ごとにすべてのメッセージを再計算するのではなく、メッセージ挿入ごとに1回実行するようにした。
  - 過剰なメモリ使用を防ぐため、LRUエビクションポリシーと10MBのサイズ制限を備えたメモリ内キャッシュを実装しました。
- **安定性とバグ修正**
  - コアイベント処理モデルを`Sentinel`を使用して完全にイベント駆動型に再構築し、SPAナビゲーション中の競合状態を解決した。
  - 古いDOMスキャンメソッド（`scanForExistingTurns`）と関連ロジックを削除し、新しいイベント駆動型アプローチを採用。
  - 処理前に対象要素を検証することで、UIインジェクションロジックを強化。
  - **テーマモーダル**: 予約名 **"Default Settings"** をテーマ名に使用できるバグを修正。
- **コード品質とリファクタリング**
  - すべてのデバウンスされたインスタンスメソッド呼び出しを `.bind(this)` を使用するように標準化し、`this` コンテキストエラーを防止。
  - EventBusを利用する全マネージャークラスに`destroy`メソッドを追加し、購読を配列で管理・解放することでメモリリークを防止。
  - アプリ起動時の主要なObserver生成処理を`PlatformAdapter`から`ObserverManager`に移管。`PlatformAdapter`はプラットフォーム固有処理の提供に専念し、`ObserverManager`が中央のオーケストレーターとして役割を明確化。
  - 以前のサイドバーオブザーバーに関連するデッドコードを削除。
  - ナビゲーションボタンコンテナの作成における堅牢性を向上させ、重複を防止。
  - **テーママネージャー**: モノリシックな `applyThemeStyles` を `_ensureStylesheets`、`_applyNonImageVariables`、`_applyImageVariables` に分解。これにより、同期処理と非同期処理が明確になり、保守性が向上。また、動的なスタイルシート DOM 参照をキャッシュすることで、冗長な参照を回避。
  - **テーマモーダルコンポーネント**:  `_saveConfigAndHandleFeedback` を導入し、設定保存時やフィードバック表示時に使用する複数のハンドラー間で重複していた `try/catch` ロジックを統合。
  - **バブル UI**: マネージャーを統合（`CollapsibleBubbleManager`、`SequentialNavManager`、`ScrollToTopManager` を単一の `BubbleUIManager` に統合）。また、プラットフォーム固有のバブルロジックをすべて `PlatformAdapter` に移動。これにより、メインコントローラーが簡素化され、コードの重複が削減され、保守性が向上。

## [1.3.6] - 2025-08-26
- **新機能**
  - **最新メッセージを自動選択**: チャットを開いた際、ナビゲーションコンソールが自動で最新メッセージを選択するように変更。
- **不具合修正**
  - [GGGUX] **無限スクロール対応**: 過去メッセージ読み込み後にナビゲーションコンソールのインデックスがずれる問題を修正。
- **改善・リファクタリング**
  - **オブザーバーの刷新**: DOM監視範囲を必要最小限に縮小し、ページ遷移中は一時停止→再開する設計に変更。Canvas/ファイルパネル用の専用オブザーバーも導入。
  - **イベント処理最適化**: 入力欄の変化は早期スキップ、既に処理済みのターンは再処理しない仕組みを追加し、無駄な処理を削減。
- **開発者向け**
  - **機能追加（ロガー拡張）**: `debug`ログレベルを追加し、`time()` / `timeEnd()`で簡易的な性能計測が可能に。
  - **機能追加（PerfMonitor）**: 関数呼び出し頻度を集計・ログ出力する軽量モニタを追加。過剰なオブザーバー発火などの診断に有効。
  - **機能追加**: JSON設定に`developer`セクションを追加して、ログレベルを設定できるようにした。
  - **機能改善**: デバッグ用関数`toggleBorders`の機能拡充。

## [1.3.5] - 2025-08-25 (private)
  - 開発内部バージョン

## [1.3.4] - 2025-08-23 (private)
- **リファクタリング**
  - **オブザーバーの初期化**: すべてのオブザーバーの起動ロジックを `PlatformAdapter` クラスに集約し、コード構造と保守性を向上。この変更により、冗長なサイズ変更イベントリスナーや未使用コードを削除。
- **修正**
  - **安定性**: ストリーミングメッセージオブザーバーにおける潜在的なメモリリークを解決し、アバターインジェクションロジックにおける競合状態を修正することで、長期的な安定性が向上。
  - [GPTUX] **安定性**: タイトルオブザーバーとサイドバーオブザーバーの堅牢性を強化。

## [1.3.3] - 2025-08-22
- **リファクタリング**
  - **スタイル管理**: `STYLE_DEFINITIONS`をUIセクションごとに整理し、`ALL_STYLE_DEFINITIONS`を導入して処理を統一。コードの可読性と保守性を向上。
  - **定数化**: 遅延時間やリトライ回数のマジックナンバーを定数オブジェクトに置換し、明示性を強化。
  - **設定画面**: 機能トグルの順序をUIレイアウトに合わせて並べ替え、直感的な配置に統一。
- **機能改善**
  - **パフォーマンス**: DOM監視を全面刷新: 高頻度要素はCSSアニメーション（Sentinel）、低頻度要素は軽量化したMutationObserverで処理し、ストリーミング中のUIラグを解消。
  - **パフォーマンス**: アバター処理最適化: animationstartイベントによる再注入方式に変更し、不要なDOMポーリングを排除。表示の安定性とパフォーマンスを両立。
- **不具合修正**
  - [GGGUX] ファイルパネルが立ち絵に隠れる問題を修正。パネル表示時にz-indexを動的に調整するObserverを追加。

## [1.3.2] - 2025-08-20
- **機能改善**
  - **パフォーマンス**: アシスタントの応答ストリーミング中の処理を最適化し、CPU負荷を大幅に軽減した。(1.3.0で目指したパフォーマンス改善の最小パッチ) 。

## [1.3.1] - 2025-08-20
- **修正**: v1.3.0で発生した、設定パネルのトグルが即時反映されないバグを修正。根本原因はObserverManagerのパフォーマンス改善を目的としたリファクタリングにあったため、この部分のロジックをv1.2.1の実装に差し戻した。
- **機能改善**: v1.3.0で導入した以下の改善は維持されています。
  - **パフォーマンス**: 立ち絵(`StandingImageManager`)の描画を最適化し、負荷の高いレイアウト計算を軽微なUI更新から分離しました。レイアウト計算は、実際にレイアウトが変更されるイベント発生時のみに限定されます。
  - **パフォーマンス**: メッセージキャッシュ(`MessageCacheManager`)から、ブラウザの強制的なリフローを引き起こす高負荷なソート処理を削除し、パフォーマンスのボトルネックを解消しました。

## [1.3.0] - 2025-08-18
- **機能改善**
  - **パフォーマンス**: DOM監視ロジック(`ObserverManager`)を根本的にリファクタリングし、AIの応答ストリーミング中に発生していた高いCPU負荷を解消しました。新しいシステムでは、高頻度のポーリングに代わって要素ごとのオブザーバーを使用するため、アバターの表示問題もより効率的に解決されます。
  - **パフォーマンス**: 立ち絵(`StandingImageManager`)の描画を最適化し、負荷の高いレイアウト計算を軽微なUI更新から分離しました。レイアウト計算は、実際にレイアウトが変更されるイベント発生時のみに限定されます。
  - **パフォーマンス**: メッセージキャッシュ(`MessageCacheManager`)から、ブラウザの強制的なリフローを引き起こす高負荷なソート処理を削除し、パフォーマンスのボトルネックを解消しました。
- **変更**
  - **アーキテクチャ**: 全てのメッセージバブルUI機能（折りたたみ、先頭へスクロール、次/前へ移動）の基本ロジックをリファクタリングしました。従来のターン基準(`processTurn`)の処理を廃止し、メッセージ中心(`processElement`)の処理に一貫して統一したことで、コードの明確性と保守性が向上しました。
  - [GGGUX] **リファクタリング**: 立ち絵の表示判定ロジックをリファクタリングし、JavaScriptオブジェクトからではなくCSSプロパティから直接状態を読み取るように変更しました。これにより、ChatGPT版のより堅牢な実装と機能的に同等になりました。

## [1.2.1] - 2025-08-15
- **機能追加**: 機能利用時に、追加UIが干渉しないように動的な位置調整機能を追加した。
  - **立ち絵:** Canvas利用時は非表示にした。
  - [GPTUX] **設定ボタン:** Canvasに干渉しないように自動的に位置が移動する。

## [1.2.0] - 2025-08-05
- **機能追加**: 複数タブで同時利用している際に、設定を自動で同期するようにした。
- **改善**: テーマ設定画面のプレビュー機能を改善した。未設定の項目にはユーザー指定のデフォルトテーマ（`defaultSet`）の値が反映されるようになり、実際の適用結果と一致する直感的な表示（WYSIWYG）となった。
- **改善**: テーマ名変更のUIを改善（インラインで変更可能にした）。
- 各種アイコンで絵文字の使用をやめてSVGを使用するようにした。
- 初期化ロジックを改善し安定性を向上させた。
- CSS周りの不具合調整（想定した設定が適用されていなかった）。
- **内部コードの改善**: その他、内部処理の改善。

## [1.1.1] - 2025-07-27
- [GPTUX] **安定性の向上:** Firefox環境において、ページの初回読み込み時にUI（設定ボタンなど）が正常に表示・動作しないことがある不安定な問題を修正。
  - **原因:** サイトのUI描画処理との競合（レースコンディション）が原因と考えられる。
  - **対策:** サイトのUIが完全に操作可能になったことをより確実に検知してからスクリプトを起動するよう、初期化ロジックを見直した。
- [GGGUX] **安定性の向上:** `GPTUX 1.1.1`の安定性向上対策を、予防的に`GGGUX`にも適用。

## [1.1.0] - 2025-07-26
- テーマ設定画面の項目順を変更。`background color` -> `text color` の順にした（全ブロックで背景色が先頭になるようにした）。	
- メッセージの開閉トグルで、確実に現在のメッセージ（ハイライトされているメッセージ）を表示するように調整。
- **メッセージキャッシュ機能の導入と最適化**: メッセージ要素の取得と管理を効率化するために、メッセージキャッシュ機能を導入した。これにより、スクリプトのパフォーマンスが向上し、特定の機能（折りたたみ、スクロール、順次ナビゲーションなど）がよりスムーズに動作する。
- **ナビゲーション機能の改善**: メッセージ間を移動する際のボタンの計算ロジックを修正し、より正確なメッセージへのジャンプを可能にした。
- **コードの共通化と保守性の向上**: プラットフォーム固有のロジックを`PlatformAdapter`クラスに集約した。
- `@connect`の定義を`p65536.github.io`から`raw.githubusercontent.com`に変更（`project_theme_sample.json`内のサンプル画像のURLも変更）
- **内部コードの改善**: その他、コードの可読性と堅牢性を高めるための修正。

## [1.0.0] - 2025-07-21
- 一般公開